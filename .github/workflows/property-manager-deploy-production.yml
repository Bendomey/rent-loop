name: Deploy Property Manager Production

on:
  push:
    paths:
      - 'apps/property-manager/**'
    branches:
      - prod
  workflow_run:
    workflows: ["Property manager CI"]
    types:
      - completed
    branches:
      - prod

jobs:
  deploy:
      name: ‚öôÔ∏è Build And Deploy Production
      runs-on: ubuntu-latest
      if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'push' }}
      concurrency: deploy-group

      env:
        FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN_PRODUCTION }}

      defaults:
        run:
          working-directory: apps/property-manager
      
      steps:
        - name: ‚¨áÔ∏è Checkout repo
          uses: actions/checkout@v4
  
        - name: üéà Setup Fly
          uses: superfly/flyctl-actions/setup-flyctl@master
    
        - name: üöÄ Deploy Production
          run:
            flyctl deploy --config fly.production.toml --remote-only 
              --build-arg COMMIT_SHA=${{ github.sha }} 
              --build-arg NODE_ENV=production