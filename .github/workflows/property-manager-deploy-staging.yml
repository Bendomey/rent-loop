name: Deploy Property Manager Staging

on:
  push:
    paths:
      - 'apps/property-manager/**'
    branches:
      - main
  workflow_run:
    workflows: ["Property manager CI"]
    types:
      - completed
    branches:
      - main

jobs:
  deploy:
      name: ⚙️ Build And Deploy Staging
      runs-on: ubuntu-latest
      if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'push' }}
      concurrency: deploy-group

      env:
        FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      defaults:
        run:
          working-directory: apps/property-manager
      
      steps:
        - name: ⬇️ Checkout repo
          uses: actions/checkout@v4
  
        - name: 🎈 Setup Fly
          uses: superfly/flyctl-actions/setup-flyctl@master
    
        - name: 🚀 Deploy Staging
          run:
            flyctl deploy --config fly.staging.toml --remote-only 
              --build-arg COMMIT_SHA=${{ github.sha }} 
              --build-arg NODE_ENV=staging